import * as tslib_1 from "tslib";
var RouterState_1;
/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { NavigationCancel, NavigationError, Router, RoutesRecognized } from '@angular/router';
import { Action, Selector, State, Store } from '@ngxs/store';
import { of } from 'rxjs';
import { Navigate, RouterCancel, RouterError, RouterNavigation } from './router.actions';
import { RouterStateSerializer } from './serializer';
import { NgZone } from '@angular/core';
let RouterState = RouterState_1 = class RouterState {
    /**
     * @param {?} _store
     * @param {?} _router
     * @param {?} _serializer
     * @param {?} _ngZone
     */
    constructor(_store, _router, _serializer, _ngZone) {
        this._store = _store;
        this._router = _router;
        this._serializer = _serializer;
        this._ngZone = _ngZone;
        this.dispatchTriggeredByRouter = false; // used only in dev mode in combination with routerReducer
        // used only in dev mode in combination with routerReducer
        this.navigationTriggeredByDispatch = false; // used only in dev mode in combination with routerReducer
        this.setUpRouterHook();
        this.setUpStoreListener();
        this.setUpStateRollbackEvents();
    }
    // used only in dev mode in combination with routerReducer
    /**
     * Selectors
     * @param {?} state
     * @return {?}
     */
    static state(state) {
        return state && state.state;
    }
    /**
     * @param {?} state
     * @return {?}
     */
    static url(state) {
        return state && state.state && state.state.url;
    }
    /**
     * @param {?} ctx
     * @param {?} action
     * @return {?}
     */
    navigate(ctx, action) {
        this._ngZone.run(() => this._router.navigate(action.path, Object.assign({ queryParams: action.queryParams }, action.extras)));
    }
    /**
     * @param {?} ctx
     * @param {?} action
     * @return {?}
     */
    angularRouterAction(ctx, action) {
        ctx.setState(Object.assign({}, ctx.getState(), { state: action.routerState, navigationId: action.event.id }));
    }
    /**
     * Hook into the angular router before each navigation action is performed
     * since the route tree can be large, we serialize it into something more manageable
     * @private
     * @return {?}
     */
    setUpRouterHook() {
        ((/** @type {?} */ (this._router))).hooks.beforePreactivation = (routerStateSnapshot) => {
            this.routerStateSnapshot = this._serializer.serialize(routerStateSnapshot);
            if (this.shouldDispatchRouterNavigation())
                this.dispatchRouterNavigation();
            return of(true);
        };
    }
    /**
     * @private
     * @return {?}
     */
    setUpStoreListener() {
        this._store.select(RouterState_1).subscribe(s => {
            this.routerState = s;
        });
        this._store.select(RouterState_1.state).subscribe(() => {
            this.navigateIfNeeded();
        });
    }
    /**
     * @private
     * @return {?}
     */
    setUpStateRollbackEvents() {
        this._router.events.subscribe(e => {
            if (e instanceof RoutesRecognized) {
                this.lastRoutesRecognized = e;
            }
            else if (e instanceof NavigationCancel) {
                this.dispatchRouterCancel(e);
            }
            else if (e instanceof NavigationError) {
                this.dispatchRouterError(e);
            }
        });
    }
    /**
     * @private
     * @return {?}
     */
    shouldDispatchRouterNavigation() {
        if (!this.routerState)
            return true;
        return !this.navigationTriggeredByDispatch;
    }
    /**
     * @private
     * @return {?}
     */
    navigateIfNeeded() {
        if (!this.routerState || !this.routerState.state) {
            return;
        }
        if (this.dispatchTriggeredByRouter)
            return;
        if (this._router.url !== this.routerState.state.url) {
            this.navigationTriggeredByDispatch = true;
            this._ngZone.run(() => this._router.navigateByUrl(this.routerState.state.url));
        }
    }
    /**
     * @private
     * @return {?}
     */
    dispatchRouterNavigation() {
        this.dispatchRouterAction(new RouterNavigation(this.routerStateSnapshot, new RoutesRecognized(this.lastRoutesRecognized.id, this.lastRoutesRecognized.url, this.lastRoutesRecognized.urlAfterRedirects, this.routerStateSnapshot)));
    }
    /**
     * @private
     * @param {?} event
     * @return {?}
     */
    dispatchRouterCancel(event) {
        this.dispatchRouterAction(new RouterCancel(this.routerStateSnapshot, this.routerState, event));
    }
    /**
     * @private
     * @param {?} event
     * @return {?}
     */
    dispatchRouterError(event) {
        this.dispatchRouterAction(new RouterError(this.routerStateSnapshot, this.routerState, new NavigationError(event.id, event.url, `${event}`)));
    }
    /**
     * @private
     * @template T
     * @param {?} action
     * @return {?}
     */
    dispatchRouterAction(action) {
        this.dispatchTriggeredByRouter = true;
        try {
            this._store.dispatch(action);
        }
        finally {
            this.dispatchTriggeredByRouter = false;
            this.navigationTriggeredByDispatch = false;
        }
    }
};
tslib_1.__decorate([
    Action(Navigate),
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", [Object, Navigate]),
    tslib_1.__metadata("design:returntype", void 0)
], RouterState.prototype, "navigate", null);
tslib_1.__decorate([
    Action([RouterNavigation, RouterError, RouterCancel]),
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", [Object, Object]),
    tslib_1.__metadata("design:returntype", void 0)
], RouterState.prototype, "angularRouterAction", null);
tslib_1.__decorate([
    Selector(),
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", [Object]),
    tslib_1.__metadata("design:returntype", void 0)
], RouterState, "state", null);
tslib_1.__decorate([
    Selector(),
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", [Object]),
    tslib_1.__metadata("design:returntype", String)
], RouterState, "url", null);
RouterState = RouterState_1 = tslib_1.__decorate([
    State({
        name: 'router',
        defaults: {
            state: null,
            navigationId: null
        }
    }),
    tslib_1.__metadata("design:paramtypes", [Store,
        Router,
        RouterStateSerializer,
        NgZone])
], RouterState);
export { RouterState };
if (false) {
    /**
     * @type {?}
     * @private
     */
    RouterState.prototype.routerStateSnapshot;
    /**
     * @type {?}
     * @private
     */
    RouterState.prototype.routerState;
    /**
     * @type {?}
     * @private
     */
    RouterState.prototype.lastRoutesRecognized;
    /**
     * @type {?}
     * @private
     */
    RouterState.prototype.dispatchTriggeredByRouter;
    /**
     * @type {?}
     * @private
     */
    RouterState.prototype.navigationTriggeredByDispatch;
    /**
     * @type {?}
     * @private
     */
    RouterState.prototype._store;
    /**
     * @type {?}
     * @private
     */
    RouterState.prototype._router;
    /**
     * @type {?}
     * @private
     */
    RouterState.prototype._serializer;
    /**
     * @type {?}
     * @private
     */
    RouterState.prototype._ngZone;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGVyLnN0YXRlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQG5neHMvcm91dGVyLXBsdWdpbi8iLCJzb3VyY2VzIjpbInNyYy9yb3V0ZXIuc3RhdGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsT0FBTyxFQUFFLGdCQUFnQixFQUFFLGVBQWUsRUFBRSxNQUFNLEVBQXVCLGdCQUFnQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDbkgsT0FBTyxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFnQixLQUFLLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDM0UsT0FBTyxFQUFFLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUUxQixPQUFPLEVBQUUsUUFBUSxFQUFnQixZQUFZLEVBQUUsV0FBVyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDdkcsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQ3JELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7SUFjMUIsV0FBVyx5QkFBWCxXQUFXOzs7Ozs7O0lBcUJ0QixZQUNVLE1BQWEsRUFDYixPQUFlLEVBQ2YsV0FBdUQsRUFDdkQsT0FBZTtRQUhmLFdBQU0sR0FBTixNQUFNLENBQU87UUFDYixZQUFPLEdBQVAsT0FBTyxDQUFRO1FBQ2YsZ0JBQVcsR0FBWCxXQUFXLENBQTRDO1FBQ3ZELFlBQU8sR0FBUCxPQUFPLENBQVE7UUFyQmpCLDhCQUF5QixHQUFHLEtBQUssQ0FBQyxDQUFDLDBEQUEwRDs7UUFDN0Ysa0NBQTZCLEdBQUcsS0FBSyxDQUFDLENBQUMsMERBQTBEO1FBc0J2RyxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7UUFDdkIsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7UUFDMUIsSUFBSSxDQUFDLHdCQUF3QixFQUFFLENBQUM7SUFDbEMsQ0FBQzs7Ozs7OztJQWxCRCxNQUFNLENBQUMsS0FBSyxDQUFDLEtBQXVC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R0FBRyxJQUFJLENBQUM7UUFDdEMsSUFBSTtZQUNGLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQzlCO2dCQUFTO1lBQ1IsSUFBSSxDQUFDLHlCQUF5QixHQUFHLEtBQUssQ0FBQztZQUN2QyxJQUFJLENBQUMsNkJBQTZCLEdBQUcsS0FBSyxDQUFDO1NBQzVDO0lBQ0gsQ0FBQztDQUNGLENBQUE7QUFyR0M7SUFEQyxNQUFNLENBQUMsUUFBUSxDQUFDOztxREFDcUMsUUFBUTs7MkNBTzdEO0FBR0Q7SUFEQyxNQUFNLENBQUMsQ0FBQyxnQkFBZ0IsRUFBRSxXQUFXLEVBQUUsWUFBWSxDQUFDLENBQUM7Ozs7c0RBT3JEO0FBckNEO0lBREMsUUFBUSxFQUFFOzs7OzhCQUdWO0FBR0Q7SUFEQyxRQUFRLEVBQUU7Ozs7NEJBR1Y7QUFuQlUsV0FBVztJQVB2QixLQUFLLENBQW1CO1FBQ3ZCLElBQUksRUFBRSxRQUFRO1FBQ2QsUUFBUSxFQUFFO1lBQ1IsS0FBSyxFQUFFLElBQUk7WUFDWCxZQUFZLEVBQUUsSUFBSTtTQUNuQjtLQUNGLENBQUM7NkNBdUJrQixLQUFLO1FBQ0osTUFBTTtRQUNGLHFCQUFxQjtRQUN6QixNQUFNO0dBekJkLFdBQVcsQ0FzSXZCO1NBdElZLFdBQVc7Ozs7OztJQUN0QiwwQ0FBaUQ7Ozs7O0lBQ2pELGtDQUFzQzs7Ozs7SUFDdEMsMkNBQStDOzs7OztJQUMvQyxnREFBMEM7Ozs7O0lBQzFDLG9EQUE4Qzs7Ozs7SUFpQjVDLDZCQUFxQjs7Ozs7SUFDckIsOEJBQXVCOzs7OztJQUN2QixrQ0FBK0Q7Ozs7O0lBQy9ELDhCQUF1QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE5hdmlnYXRpb25DYW5jZWwsIE5hdmlnYXRpb25FcnJvciwgUm91dGVyLCBSb3V0ZXJTdGF0ZVNuYXBzaG90LCBSb3V0ZXNSZWNvZ25pemVkIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcclxuaW1wb3J0IHsgQWN0aW9uLCBTZWxlY3RvciwgU3RhdGUsIFN0YXRlQ29udGV4dCwgU3RvcmUgfSBmcm9tICdAbmd4cy9zdG9yZSc7XHJcbmltcG9ydCB7IG9mIH0gZnJvbSAncnhqcyc7XHJcblxyXG5pbXBvcnQgeyBOYXZpZ2F0ZSwgUm91dGVyQWN0aW9uLCBSb3V0ZXJDYW5jZWwsIFJvdXRlckVycm9yLCBSb3V0ZXJOYXZpZ2F0aW9uIH0gZnJvbSAnLi9yb3V0ZXIuYWN0aW9ucyc7XHJcbmltcG9ydCB7IFJvdXRlclN0YXRlU2VyaWFsaXplciB9IGZyb20gJy4vc2VyaWFsaXplcic7XHJcbmltcG9ydCB7IE5nWm9uZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5cclxuZXhwb3J0IHR5cGUgUm91dGVyU3RhdGVNb2RlbDxUID0gUm91dGVyU3RhdGVTbmFwc2hvdD4gPSB7XHJcbiAgc3RhdGU6IFQ7XHJcbiAgbmF2aWdhdGlvbklkOiBudW1iZXI7XHJcbn07XHJcblxyXG5AU3RhdGU8Um91dGVyU3RhdGVNb2RlbD4oe1xyXG4gIG5hbWU6ICdyb3V0ZXInLFxyXG4gIGRlZmF1bHRzOiB7XHJcbiAgICBzdGF0ZTogbnVsbCxcclxuICAgIG5hdmlnYXRpb25JZDogbnVsbFxyXG4gIH1cclxufSlcclxuZXhwb3J0IGNsYXNzIFJvdXRlclN0YXRlIHtcclxuICBwcml2YXRlIHJvdXRlclN0YXRlU25hcHNob3Q6IFJvdXRlclN0YXRlU25hcHNob3Q7XHJcbiAgcHJpdmF0ZSByb3V0ZXJTdGF0ZTogUm91dGVyU3RhdGVNb2RlbDtcclxuICBwcml2YXRlIGxhc3RSb3V0ZXNSZWNvZ25pemVkOiBSb3V0ZXNSZWNvZ25pemVkO1xyXG4gIHByaXZhdGUgZGlzcGF0Y2hUcmlnZ2VyZWRCeVJvdXRlciA9IGZhbHNlOyAvLyB1c2VkIG9ubHkgaW4gZGV2IG1vZGUgaW4gY29tYmluYXRpb24gd2l0aCByb3V0ZXJSZWR1Y2VyXHJcbiAgcHJpdmF0ZSBuYXZpZ2F0aW9uVHJpZ2dlcmVkQnlEaXNwYXRjaCA9IGZhbHNlOyAvLyB1c2VkIG9ubHkgaW4gZGV2IG1vZGUgaW4gY29tYmluYXRpb24gd2l0aCByb3V0ZXJSZWR1Y2VyXHJcblxyXG4gIC8qKlxyXG4gICAqIFNlbGVjdG9yc1xyXG4gICAqL1xyXG5cclxuICBAU2VsZWN0b3IoKVxyXG4gIHN0YXRpYyBzdGF0ZShzdGF0ZTogUm91dGVyU3RhdGVNb2RlbCkge1xyXG4gICAgcmV0dXJuIHN0YXRlICYmIHN0YXRlLnN0YXRlO1xyXG4gIH1cclxuXHJcbiAgQFNlbGVjdG9yKClcclxuICBzdGF0aWMgdXJsKHN0YXRlOiBSb3V0ZXJTdGF0ZU1vZGVsKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcclxuICAgIHJldHVybiBzdGF0ZSAmJiBzdGF0ZS5zdGF0ZSAmJiBzdGF0ZS5zdGF0ZS51cmw7XHJcbiAgfVxyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgX3N0b3JlOiBTdG9yZSxcclxuICAgIHByaXZhdGUgX3JvdXRlcjogUm91dGVyLFxyXG4gICAgcHJpdmF0ZSBfc2VyaWFsaXplcjogUm91dGVyU3RhdGVTZXJpYWxpemVyPFJvdXRlclN0YXRlU25hcHNob3Q+LFxyXG4gICAgcHJpdmF0ZSBfbmdab25lOiBOZ1pvbmVcclxuICApIHtcclxuICAgIHRoaXMuc2V0VXBSb3V0ZXJIb29rKCk7XHJcbiAgICB0aGlzLnNldFVwU3RvcmVMaXN0ZW5lcigpO1xyXG4gICAgdGhpcy5zZXRVcFN0YXRlUm9sbGJhY2tFdmVudHMoKTtcclxuICB9XHJcblxyXG4gIEBBY3Rpb24oTmF2aWdhdGUpXHJcbiAgbmF2aWdhdGUoY3R4OiBTdGF0ZUNvbnRleHQ8Um91dGVyU3RhdGVNb2RlbD4sIGFjdGlvbjogTmF2aWdhdGUpIHtcclxuICAgIHRoaXMuX25nWm9uZS5ydW4oKCkgPT5cclxuICAgICAgdGhpcy5fcm91dGVyLm5hdmlnYXRlKGFjdGlvbi5wYXRoLCB7XHJcbiAgICAgICAgcXVlcnlQYXJhbXM6IGFjdGlvbi5xdWVyeVBhcmFtcyxcclxuICAgICAgICAuLi5hY3Rpb24uZXh0cmFzXHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgQEFjdGlvbihbUm91dGVyTmF2aWdhdGlvbiwgUm91dGVyRXJyb3IsIFJvdXRlckNhbmNlbF0pXHJcbiAgYW5ndWxhclJvdXRlckFjdGlvbihjdHg6IFN0YXRlQ29udGV4dDxSb3V0ZXJTdGF0ZU1vZGVsPiwgYWN0aW9uOiBSb3V0ZXJBY3Rpb248YW55LCBSb3V0ZXJTdGF0ZVNuYXBzaG90Pikge1xyXG4gICAgY3R4LnNldFN0YXRlKHtcclxuICAgICAgLi4uY3R4LmdldFN0YXRlKCksXHJcbiAgICAgIHN0YXRlOiBhY3Rpb24ucm91dGVyU3RhdGUsXHJcbiAgICAgIG5hdmlnYXRpb25JZDogYWN0aW9uLmV2ZW50LmlkXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEhvb2sgaW50byB0aGUgYW5ndWxhciByb3V0ZXIgYmVmb3JlIGVhY2ggbmF2aWdhdGlvbiBhY3Rpb24gaXMgcGVyZm9ybWVkXHJcbiAgICogc2luY2UgdGhlIHJvdXRlIHRyZWUgY2FuIGJlIGxhcmdlLCB3ZSBzZXJpYWxpemUgaXQgaW50byBzb21ldGhpbmcgbW9yZSBtYW5hZ2VhYmxlXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzZXRVcFJvdXRlckhvb2soKTogdm9pZCB7XHJcbiAgICAoPGFueT50aGlzLl9yb3V0ZXIpLmhvb2tzLmJlZm9yZVByZWFjdGl2YXRpb24gPSAocm91dGVyU3RhdGVTbmFwc2hvdDogUm91dGVyU3RhdGVTbmFwc2hvdCkgPT4ge1xyXG4gICAgICB0aGlzLnJvdXRlclN0YXRlU25hcHNob3QgPSB0aGlzLl9zZXJpYWxpemVyLnNlcmlhbGl6ZShyb3V0ZXJTdGF0ZVNuYXBzaG90KTtcclxuICAgICAgaWYgKHRoaXMuc2hvdWxkRGlzcGF0Y2hSb3V0ZXJOYXZpZ2F0aW9uKCkpIHRoaXMuZGlzcGF0Y2hSb3V0ZXJOYXZpZ2F0aW9uKCk7XHJcbiAgICAgIHJldHVybiBvZih0cnVlKTtcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHNldFVwU3RvcmVMaXN0ZW5lcigpOiB2b2lkIHtcclxuICAgIHRoaXMuX3N0b3JlLnNlbGVjdChSb3V0ZXJTdGF0ZSkuc3Vic2NyaWJlKHMgPT4ge1xyXG4gICAgICB0aGlzLnJvdXRlclN0YXRlID0gcztcclxuICAgIH0pO1xyXG4gICAgdGhpcy5fc3RvcmUuc2VsZWN0KFJvdXRlclN0YXRlLnN0YXRlKS5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICB0aGlzLm5hdmlnYXRlSWZOZWVkZWQoKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzZXRVcFN0YXRlUm9sbGJhY2tFdmVudHMoKTogdm9pZCB7XHJcbiAgICB0aGlzLl9yb3V0ZXIuZXZlbnRzLnN1YnNjcmliZShlID0+IHtcclxuICAgICAgaWYgKGUgaW5zdGFuY2VvZiBSb3V0ZXNSZWNvZ25pemVkKSB7XHJcbiAgICAgICAgdGhpcy5sYXN0Um91dGVzUmVjb2duaXplZCA9IGU7XHJcbiAgICAgIH0gZWxzZSBpZiAoZSBpbnN0YW5jZW9mIE5hdmlnYXRpb25DYW5jZWwpIHtcclxuICAgICAgICB0aGlzLmRpc3BhdGNoUm91dGVyQ2FuY2VsKGUpO1xyXG4gICAgICB9IGVsc2UgaWYgKGUgaW5zdGFuY2VvZiBOYXZpZ2F0aW9uRXJyb3IpIHtcclxuICAgICAgICB0aGlzLmRpc3BhdGNoUm91dGVyRXJyb3IoZSk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzaG91bGREaXNwYXRjaFJvdXRlck5hdmlnYXRpb24oKTogYm9vbGVhbiB7XHJcbiAgICBpZiAoIXRoaXMucm91dGVyU3RhdGUpIHJldHVybiB0cnVlO1xyXG4gICAgcmV0dXJuICF0aGlzLm5hdmlnYXRpb25UcmlnZ2VyZWRCeURpc3BhdGNoO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBuYXZpZ2F0ZUlmTmVlZGVkKCk6IHZvaWQge1xyXG4gICAgaWYgKCF0aGlzLnJvdXRlclN0YXRlIHx8ICF0aGlzLnJvdXRlclN0YXRlLnN0YXRlKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGlmICh0aGlzLmRpc3BhdGNoVHJpZ2dlcmVkQnlSb3V0ZXIpIHJldHVybjtcclxuXHJcbiAgICBpZiAodGhpcy5fcm91dGVyLnVybCAhPT0gdGhpcy5yb3V0ZXJTdGF0ZS5zdGF0ZS51cmwpIHtcclxuICAgICAgdGhpcy5uYXZpZ2F0aW9uVHJpZ2dlcmVkQnlEaXNwYXRjaCA9IHRydWU7XHJcbiAgICAgIHRoaXMuX25nWm9uZS5ydW4oKCkgPT4gdGhpcy5fcm91dGVyLm5hdmlnYXRlQnlVcmwodGhpcy5yb3V0ZXJTdGF0ZS5zdGF0ZS51cmwpKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgZGlzcGF0Y2hSb3V0ZXJOYXZpZ2F0aW9uKCk6IHZvaWQge1xyXG4gICAgdGhpcy5kaXNwYXRjaFJvdXRlckFjdGlvbihcclxuICAgICAgbmV3IFJvdXRlck5hdmlnYXRpb24oXHJcbiAgICAgICAgdGhpcy5yb3V0ZXJTdGF0ZVNuYXBzaG90LFxyXG4gICAgICAgIG5ldyBSb3V0ZXNSZWNvZ25pemVkKFxyXG4gICAgICAgICAgdGhpcy5sYXN0Um91dGVzUmVjb2duaXplZC5pZCxcclxuICAgICAgICAgIHRoaXMubGFzdFJvdXRlc1JlY29nbml6ZWQudXJsLFxyXG4gICAgICAgICAgdGhpcy5sYXN0Um91dGVzUmVjb2duaXplZC51cmxBZnRlclJlZGlyZWN0cyxcclxuICAgICAgICAgIHRoaXMucm91dGVyU3RhdGVTbmFwc2hvdFxyXG4gICAgICAgIClcclxuICAgICAgKVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZGlzcGF0Y2hSb3V0ZXJDYW5jZWwoZXZlbnQ6IE5hdmlnYXRpb25DYW5jZWwpOiB2b2lkIHtcclxuICAgIHRoaXMuZGlzcGF0Y2hSb3V0ZXJBY3Rpb24obmV3IFJvdXRlckNhbmNlbCh0aGlzLnJvdXRlclN0YXRlU25hcHNob3QsIHRoaXMucm91dGVyU3RhdGUsIGV2ZW50KSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGRpc3BhdGNoUm91dGVyRXJyb3IoZXZlbnQ6IE5hdmlnYXRpb25FcnJvcik6IHZvaWQge1xyXG4gICAgdGhpcy5kaXNwYXRjaFJvdXRlckFjdGlvbihcclxuICAgICAgbmV3IFJvdXRlckVycm9yKHRoaXMucm91dGVyU3RhdGVTbmFwc2hvdCwgdGhpcy5yb3V0ZXJTdGF0ZSwgbmV3IE5hdmlnYXRpb25FcnJvcihldmVudC5pZCwgZXZlbnQudXJsLCBgJHtldmVudH1gKSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGRpc3BhdGNoUm91dGVyQWN0aW9uPFQ+KGFjdGlvbjogUm91dGVyQWN0aW9uPFQ+KTogdm9pZCB7XHJcbiAgICB0aGlzLmRpc3BhdGNoVHJpZ2dlcmVkQnlSb3V0ZXIgPSB0cnVlO1xyXG4gICAgdHJ5IHtcclxuICAgICAgdGhpcy5fc3RvcmUuZGlzcGF0Y2goYWN0aW9uKTtcclxuICAgIH0gZmluYWxseSB7XHJcbiAgICAgIHRoaXMuZGlzcGF0Y2hUcmlnZ2VyZWRCeVJvdXRlciA9IGZhbHNlO1xyXG4gICAgICB0aGlzLm5hdmlnYXRpb25UcmlnZ2VyZWRCeURpc3BhdGNoID0gZmFsc2U7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcbiJdfQ==